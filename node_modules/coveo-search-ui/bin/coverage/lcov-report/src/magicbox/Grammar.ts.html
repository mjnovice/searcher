<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/magicbox/Grammar.ts</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">src/magicbox/Grammar.ts</span></h1>
    <h2>
        Statements: <span class="metric">95.24% <small>(60 / 63)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">81.82% <small>(18 / 22)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(12 / 12)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">94.92% <small>(56 / 59)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">src/magicbox/</a> &#187; Grammar.ts</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-yes">220</span>
<span class="cline-any cline-yes">839</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">839</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">839</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">3434</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">356</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">847</span>
<span class="cline-any cline-yes">847</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">847</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">500</span>
<span class="cline-any cline-yes">364</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">434</span>
<span class="cline-any cline-yes">427</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">915</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">741</span>
<span class="cline-any cline-yes">741</span>
<span class="cline-any cline-yes">741</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">174</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">341</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-yes">915</span>
<span class="cline-any cline-yes">915</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">347</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { ExpressionRef } from './Expression/ExpressionRef';
import { Expression, ExpressionDef } from './Expression/Expression';
import { ExpressionOptions } from './Expression/ExpressionOptions';
import { ExpressionRegExp } from './Expression/ExpressionRegExp';
import _ = require('underscore');
import { ExpressionFunction, ExpressionFunctionArgument } from './Expression/ExpressionFunction';
import { ExpressionConstant } from './Expression/ExpressionConstant';
import { ExpressionList } from './Expression/ExpressionList';
import { Result } from './Result/Result';
&nbsp;
export class Grammar {
  public start: ExpressionRef;
  public expressions: { [id: string]: Expression } = {};
&nbsp;
  constructor(start: string, <span class="missing-if-branch" title="if path not taken" >I</span>expressions: { [id: string]: ExpressionDef } = {}) {
    this.start = new ExpressionRef(start, null, 'start', this);
    this.addExpressions(expressions);
  }
&nbsp;
  public addExpressions(expressions: { [id: string]: ExpressionDef }) {
    _.each(expressions, (basicExpression: ExpressionDef, id: string) =&gt; {
      this.addExpression(id, basicExpression);
    });
  }
&nbsp;
  public addExpression(id: string, basicExpression: ExpressionDef) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (id in this.expressions) {
<span class="cstat-no" title="statement not covered" >      throw new Error('Grammar already contain the id:' + id);</span>
    }
    this.expressions[id] = Grammar.buildExpression(basicExpression, id, this);
  }
&nbsp;
  public getExpression(id: string) {
    return this.expressions[id];
  }
&nbsp;
  public parse(value: string): Result {
    return this.start.parse(value, true);
  }
&nbsp;
  public static buildExpression(value: ExpressionDef, id: string, grammar: Grammar): Expression {
    const type = typeof value;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (type == 'undefined') {
<span class="cstat-no" title="statement not covered" >      throw new Error('Invalid Expression: ' + value);</span>
    }
    if (_.isString(value)) {
      return this.buildStringExpression(&lt;string&gt;value, id, grammar);
    }
    if (_.isArray(value)) {
      return new ExpressionOptions(_.map(&lt;string[]&gt;value, (v: string, i) =&gt; new ExpressionRef(v, null, id + '_' + i, grammar)), id);
    }
    if (_.isRegExp(value)) {
      return new ExpressionRegExp(&lt;RegExp&gt;value, id, grammar);
    }
    <span class="missing-if-branch" title="else path not taken" >E</span>if (_.isFunction(value)) {
      return new ExpressionFunction(&lt;ExpressionFunctionArgument&gt;value, id, grammar);
    }
<span class="cstat-no" title="statement not covered" >    throw new Error('Invalid Expression: ' + value);</span>
  }
&nbsp;
  public static buildStringExpression(value: string, id: string, grammar: Grammar): Expression {
    const matchs = Grammar.stringMatch(value, Grammar.spliter);
    const expressions = _.map(matchs, (match: string[], i: number): Expression =&gt; {
      if (match[1]) {
        // Ref
        const ref = match[1];
        const occurrence = match[3] ? Number(match[3]) : match[2] || null;
        return new ExpressionRef(ref, occurrence, id + '_' + i, grammar);
      } else {
        // Constant
        return new ExpressionConstant(match[4], id + '_' + i);
      }
    });
    if (expressions.length == 1) {
      const expression = expressions[0];
      expression.id = id;
      return expression;
    } else {
      return new ExpressionList(expressions, id);
    }
  }
&nbsp;
  public static stringMatch(str: string, re: RegExp) {
    const groups: string[][] = [];
    const cloneRegExp = new RegExp(re.source, 'g');
    let group: RegExpExecArray = cloneRegExp.exec(str);
&nbsp;
    while (group !== null) {
      groups.push(group);
      group = cloneRegExp.exec(str);
    }
    return groups;
  }
&nbsp;
  static spliter = /\[(\w+)(\*|\+|\?|\{([1-9][0-9]*)\})?\]|(.[^\[]*)/;
}
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Feb 11 2020 21:33:22 GMT+0000 (UTC)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
